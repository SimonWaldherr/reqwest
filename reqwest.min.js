/*!
  * Reqwest! A general purpose XHR connection manager
  * (c) Dustin Diaz 2012
  * https://github.com/ded/reqwest
  * license MIT
  */
(function(name,context,definition){if(typeof module!='undefined'&&module.exports)module.exports=definition()else if(typeof define=='function'&&define.amd)define(definition)else context[name]=definition()})('reqwest',this,function(){var win=window,doc=document,twoHundo=/^20\d$/,byTag='getElementsByTagName',readyState='readyState',contentType='Content-Type',requestedWith='X-Requested-With',head=doc[byTag]('head')[0],uniqid=0,callbackPrefix='reqwest_'+(+new Date()),lastValue,xmlHttpRequest='XMLHttpRequest',noop=function(){}var isArray=typeof Array.isArray=='function'?Array.isArray:function(a){return a instanceof Array}var defaultHeaders={contentType:'application/x-www-form-urlencoded',requestedWith:xmlHttpRequest,accept:{'*':'text/javascript, text/html, application/xml, text/xml, */*',xml:'application/xml, text/xml',html:'text/html',text:'text/plain',json:'application/json, text/javascript',js:'application/javascript, text/javascript'}}var xhr=win[xmlHttpRequest]?function(){return new XMLHttpRequest()}:function(){return new ActiveXObject('Microsoft.XMLHTTP')}function handleReadyState(o,success,error){return function(){if(o&&o[readyState]==4){o.onreadystatechange=noop;if(twoHundo.test(o.status)){success(o)}else{error(o)}}}}function setHeaders(http,o){var headers=o.headers||{},h headers.Accept=headers.Accept||defaultHeaders.accept[o.type]||defaultHeaders.accept['*']if(!o.crossOrigin&&!headers[requestedWith])headers[requestedWith]=defaultHeaders.requestedWith if(!headers[contentType])headers[contentType]=o.contentType||defaultHeaders.contentType for(h in headers){headers.hasOwnProperty(h)&&http.setRequestHeader(h,headers[h])}}function setCredentials(http,o){if(typeof o.withCredentials!=="undefined"&&typeof http.withCredentials!=="undefined"){http.withCredentials=!!o.withCredentials}}function generalCallback(data){lastValue=data}function urlappend(url,s){return url+(/\?/.test(url)?'&':'?')+s}function handleJsonp(o,fn,err,url){var reqId=uniqid++,cbkey=o.jsonpCallback||'callback',cbval=o.jsonpCallbackName||reqwest.getcallbackPrefix(reqId),cbreg=new RegExp('((^|\\?|&)'+cbkey+')=([^&]+)'),match=url.match(cbreg),script=doc.createElement('script'),loaded=0,isIE10=navigator.userAgent.indexOf('MSIE 10.0')!==-1 if(match){if(match[3]==='?'){url=url.replace(cbreg,'$1='+cbval)}else{cbval=match[3]}}else{url=urlappend(url,cbkey+'='+cbval)}win[cbval]=generalCallback script.type='text/javascript'script.src=url script.async=true if(typeof script.onreadystatechange!=='undefined'&&!isIE10){script.event='onclick'script.htmlFor=script.id='_reqwest_'+reqId}script.onload=script.onreadystatechange=function(){if((script[readyState]&&script[readyState]!=='complete'&&script[readyState]!=='loaded')||loaded){return false}script.onload=script.onreadystatechange=null script.onclick&&script.onclick()o.success&&o.success(lastValue)lastValue=undefined head.removeChild(script)loaded=1}head.appendChild(script)}function getRequest(o,fn,err){var method=(o.method||'GET').toUpperCase(),url=typeof o==='string'?o:o.url,data=(o.processData!==false&&o.data&&typeof o.data!=='string')?reqwest.toQueryString(o.data):(o.data||null),httpif((o.type=='jsonp'||method=='GET')&&data){url=urlappend(url,data)data=null}if(o.type=='jsonp')return handleJsonp(o,fn,err,url)http=xhr()http.open(method,url,true)setHeaders(http,o)setCredentials(http,o)http.onreadystatechange=handleReadyState(http,fn,err)o.before&&o.before(http)http.send(data)return http}function Reqwest(o,fn){this.o=o this.fn=fn init.apply(this,arguments)}function setType(url){var m=url.match(/\.(json|jsonp|html|xml)(\?|$)/)return m?m[1]:'js'}function init(o,fn){this.url=typeof o=='string'?o:o.url this.timeout=null var type=o.type||setType(this.url),self=this,fulfillmentHandlers=[],errorHandlers=[],completeHandlers=[],fulfilled=false,erred=false,responseArgs={}this._fulfilled=falsethis._fulfillmentHandlers=[]this._errorHandlers=[]this._completeHandlers=[]this._erred=false this._responseArgs={}var self=this,type=o.type||setType(this.url)fn=fn||function(){}if(o.timeout){this.timeout=setTimeout(function(){self.abort()},o.timeout)}if(o.success){fulfillmentHandlers.push(function(){o.success.apply(o,arguments)})}if(o.error){errorHandlers.push(function(){o.error.apply(o,arguments)})}if(o.complete){completeHandlers.push(function(){this._fulfillmentHandlers.push(function(){o.success.apply(o,arguments)})}if(o.error){this._errorHandlers.push(function(){o.error.apply(o,arguments)})}if(o.complete){this._completeHandlers.push(function(){o.complete.apply(o,arguments)})}this.then=function(fulfillmentHandler,errorHandler){if(fulfilled){fulfillmentHandler(responseArgs.resp)}else if(erred){errorHandler(responseArgs.resp,responseArgs.msg,responseArgs.t)}else{fulfillmentHandlers.push(fulfillmentHandler)errorHandlers.push(errorHandler)}return this}this.fail=function(errorHandler){if(erred){errorHandler(responseArgs.resp,responseArgs.msg,responseArgs.t)}else{errorHandlers.push(errorHandler)}return this}this.always=function(completeHandler){if(fulfilled||erred){completeHandler(responseArgs.resp)}else{completeHandlers.push(completeHandler)}return this}function complete(resp){o.timeout&&clearTimeout(self.timeout)self.timeout=null while(completeHandlers.length>0){completeHandlers.shift()(resp)function complete(resp){o.timeout&&clearTimeout(self.timeout)self.timeout=null while(self._completeHandlers.length>0){self._completeHandlers.shift()(resp)}}function success(resp){var r=resp.responseText if(r){switch(type){case'json':try{resp=win.JSON?win.JSON.parse(r):eval('('+r+')')}catch(err){return error(resp,'Could not parse JSON in response',err)}break;case'js':resp=eval(r)break;case'html':resp=r break;case'xml':resp=resp.responseXML;break}}responseArgs.resp=resp fulfilled=true self._responseArgs.resp=resp self._fulfilled=true fn(resp)while(self._fulfillmentHandlers.length>0){self._fulfillmentHandlers.shift()(resp)}fn(resp)while(fulfillmentHandlers.length>0){fulfillmentHandlers.shift()(resp)}complete(resp)}function error(resp,msg,t){responseArgs.resp=resp responseArgs.msg=msg responseArgs.t=t erred=true while(errorHandlers.length>0){errorHandlers.shift()(resp,msg,t)self._responseArgs.resp=resp self._responseArgs.msg=msg self._responseArgs.t=t self._erred=true while(self._errorHandlers.length>0){self._errorHandlers.shift()(resp,msg,t)}complete(resp)}this.request=getRequest(o,success,error)}Reqwest.prototype={abort:function(){this.request.abort()},retry:function(){init.call(this,this.o,this.fn)},then:function(success,fail){if(this._fulfilled){success(this._responseArgs.resp)}else if(this._erred){fail(this._responseArgs.resp,this._responseArgs.msg,this._responseArgs.t)}else{this._fulfillmentHandlers.push(success)this._errorHandlers.push(fail)}return this},always:function(fn){if(this._fulfilled||this._erred){fn(this._responseArgs.resp)}else{this._completeHandlers.push(fn)}return this},fail:function(fn){if(this._erred){fn(this._responseArgs.resp,this._responseArgs.msg,this._responseArgs.t)}else{this._errorHandlers.push(fn)}return this}}function reqwest(o,fn){return new Reqwest(o,fn)}function normalize(s){return s?s.replace(/\r?\n/g,'\r\n'):''}function serial(el,cb){var n=el.name,t=el.tagName.toLowerCase(),optCb=function(o){if(o&&!o.disabled)cb(n,normalize(o.attributes.value&&o.attributes.value.specified?o.value:o.text))}if(el.disabled||!n)return;switch(t){case'input':if(!/reset|button|image|file/i.test(el.type)){var ch=/checkbox/i.test(el.type),ra=/radio/i.test(el.type),val=el.value;(!(ch||ra)||el.checked)&&cb(n,normalize(ch&&val===''?'on':val))}break;case'textarea':cb(n,normalize(el.value))break;case'select':if(el.type.toLowerCase()==='select-one'){optCb(el.selectedIndex>=0?el.options[el.selectedIndex]:null)}else{for(var i=0;el.length&&i<el.length;i++){el.options[i].selected&&optCb(el.options[i])}}break}}function eachFormElement(){var cb=this,e,i,j,serializeSubtags=function(e,tags){for(var i=0;i<tags.length;i++){var fa=e[byTag](tags[i])for(j=0;j<fa.length;j++)serial(fa[j],cb)}}for(i=0;i<arguments.length;i++){e=arguments[i]if(/input|select|textarea/i.test(e.tagName))serial(e,cb)serializeSubtags(e,['input','select','textarea'])}}function serializeQueryString(){return reqwest.toQueryString(reqwest.serializeArray.apply(null,arguments))}function serializeHash(){var hash={}eachFormElement.apply(function(name,value){if(name in hash){hash[name]&&!isArray(hash[name])&&(hash[name]=[hash[name]])hash[name].push(value)}else hash[name]=value},arguments)return hash}reqwest.serializeArray=function(){var arr=[]eachFormElement.apply(function(name,value){arr.push({name:name,value:value})},arguments)return arr}reqwest.serialize=function(){if(arguments.length===0)return''var opt,fn,args=Array.prototype.slice.call(arguments,0)opt=args.pop()opt&&opt.nodeType&&args.push(opt)&&(opt=null)opt&&(opt=opt.type)if(opt=='map')fn=serializeHash else if(opt=='array')fn=reqwest.serializeArray else fn=serializeQueryString return fn.apply(null,args)}reqwest.toQueryString=function(o){var qs='',i,enc=encodeURIComponent,push=function(k,v){qs+=enc(k)+'='+enc(v)+'&'}if(isArray(o)){for(i=0;o&&i<o.length;i++)push(o[i].name,o[i].value)}else{for(var k in o){if(!Object.hasOwnProperty.call(o,k))continue;var v=o[k]if(isArray(v)){for(i=0;i<v.length;i++)push(k,v[i])}else push(k,o[k])}}return qs.replace(/&$/,'').replace(/%20/g,'+')}reqwest.getcallbackPrefix=function(reqId){return callbackPrefix}reqwest.compat=function(o,fn){if(o){o.type&&(o.method=o.type)&&delete o.type o.dataType&&(o.type=o.dataType)o.jsonpCallback&&(o.jsonpCallbackName=o.jsonpCallback)&&delete o.jsonpCallback o.jsonp&&(o.jsonpCallback=o.jsonp)}return new Reqwest(o,fn)}return reqwest});
